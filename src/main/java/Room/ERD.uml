@startuml
skinparam monochrome true
skinparam shadowing false
skinparam classAttributeIconSize 0

package "实体层 (Entities)" {
    class EscapeRoom {
        - id: Long
        - name: String
        - roomIds: List<Long>
    }

    class Room {
        - id: Long
        - name: String
        - difficulty: String
        - clueIds: List<Long>
        - decorationIds: List<Long>
    }

    class Clue {
        - id: Long
        - name: String
        - theme: String
        - type: String
        - price: Double
        - quantity: int
        - reward: String
    }

    class Decoration {
        - id: Long
        - name: String
        - material: String
        - price: Double
        - quantity: int
    }

    class Player {
        - id: Long
        - name: String
        - subscribed: boolean
    }

    class Certificate {
        - id: Long
        - playerId: Long
        - playerName: String
        - roomName: String
        - achievement: String
        - date: LocalDateTime
    }

    class Ticket {
        - id: Long
        - playerId: Long
        - playerName: String
        - price: Double
        - purchaseDate: LocalDateTime
    }
}

note right of EscapeRoom
  主逃脱室，只有一个实例
  持有所有房间ID
end note

note right of Room
  每个房间持有自己使用的
  线索ID和装饰物ID
end note

note right of Clue::reward
  奖励直接存为字符串
  不单独建Reward表
end note

package "DAO层" {
    interface EscapeRoomDao {
        + save(er: EscapeRoom)
        + findAll(): List<EscapeRoom>
        + findById(id: Long): EscapeRoom
    }
    class EscapeRoomDaoImpl {
        + Connection conn
    }

    interface RoomDao {
        + save(room: Room)
        + delete(id: Long)
        + findAll(): List<Room>
        + findById(id: Long): Room
    }
    class RoomDaoImpl

    interface ClueDao {
        + save(clue: Clue)
        + updateQuantity(id: Long, qty: int)
        + findAll(): List<Clue>
        + findById(id: Long): Clue
    }
    class ClueDaoImpl

    interface DecorationDao {
        + save(dec: Decoration)
        + updateQuantity(id: Long, qty: int)
        + findAll(): List<Decoration>
    }
    class DecorationDaoImpl

    interface PlayerDao {
        + save(player: Player)
        + findAll(): List<Player>
        + findById(id: Long): Player
    }
    class PlayerDaoImpl

    interface CertificateDao {
        + save(cert: Certificate)
        + findByPlayerId(playerId: Long): List<Certificate>
    }
    class CertificateDaoImpl

    interface TicketDao {
        + save(ticket: Ticket)
        + getTotalRevenue(): Double
    }
    class TicketDaoImpl
}

EscapeRoomDao <|.. EscapeRoomDaoImpl
RoomDao <|.. RoomDaoImpl
ClueDao <|.. ClueDaoImpl
DecorationDao <|.. DecorationDaoImpl
PlayerDao <|.. PlayerDaoImpl
CertificateDao <|.. CertificateDaoImpl
TicketDao <|.. TicketDaoImpl

package "Service层" {
    class EscapeRoomService {
        + createEscapeRoom(name: String)
        + getEscapeRoom(): EscapeRoom
    }

    class RoomService {
        + addRoom(name: String, difficulty: String)
        + removeRoom(id: Long)
        + listAllRooms(): List<Room>
        + assignClueToRoom(roomId: Long, clueId: Long)
        + assignDecorationToRoom(roomId: Long, decId: Long)
    }

    class InventoryService {
        + addClue(clue: Clue)
        + addDecoration(dec: Decoration)
        + removeOneItem(itemType: String, id: Long)
        + getTotalInventoryValue(): Double
        + listAllInventory(): Map<String, List<?>>
    }

    class PlayerService {
        + registerPlayer(name: String): Player
        + subscribeNotifications(id: Long)
        + grantCertificate(playerId: Long, roomName: String, achievement: String)
    }

    class TicketService {
        + sellTicket(playerId: Long, price: Double): Ticket
        + getTotalRevenue(): Double
    }

    class NotificationService {
        + registerObserver(player: Player)
        + removeObserver(playerId: Long)
        + notify(event: String)
        + notifyNewClue(clueName: String)
        + notifyRoomCompleted(playerName: String, roomName: String)
    }
}

EscapeRoomService --> EscapeRoomDao
RoomService --> RoomDao
RoomService --> EscapeRoomDao
InventoryService --> ClueDao
InventoryService --> DecorationDao
PlayerService --> PlayerDao
PlayerService --> CertificateDao
TicketService --> TicketDao
NotificationService --> PlayerDao

package "界面层" {
    class Menu {
        + showMainMenu()
        - scanner: Scanner
    }

    class Controller {
        + main(args: String[])
    }
}

Controller --> Menu : 启动
Menu --> EscapeRoomService
Menu --> RoomService
Menu --> InventoryService
Menu --> PlayerService
Menu --> TicketService
Menu --> NotificationService

note bottom of Menu
  控制台文字菜单
  调用所有Service完成功能
  包括：
  1.添加房间 2.添加线索/装饰物
  3.查看库存总价值 4.卖出门票
  5.完成房间发证书 6.订阅通知等
end note

@enduml